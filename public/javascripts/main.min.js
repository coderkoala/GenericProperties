(function(e,t){"use strict";var a={subject:"Lead Referral Near You",emailAgentsAPIEndpoint:"/api/v1/email",currentPageRouteEndpoint:"/geolocation",defaultDistanceToRenderNearbyAgents:5,emailBodyContent:'<p style="margin: 0; font-size: 14px; line-height: 1.8; word-break: break-word; text-align: justify; mso-line-height-alt: 25px; margin-top: 0; margin-bottom: 0;">I work for Joe Oppen, an agent in United Real Estate located in New Jersey. I have a possible referral in your area.</p><p style="margin: 0; font-size: 14px; line-height: 1.8; word-break: break-word; text-align: justify; mso-line-height-alt: 25px; margin-top: 0; margin-bottom: 0;"> </p><p style="margin: 0; font-size: 14px; line-height: 1.8; word-break: break-word; text-align: justify; mso-line-height-alt: 25px; margin-top: 0; margin-bottom: 0;">Would you be interested?</p><p style="margin: 0; font-size: 14px; line-height: 1.8; word-break: break-word; text-align: justify; mso-line-height-alt: 25px; margin-top: 0; margin-bottom: 0;"> </p><p style="margin: 0; font-size: 14px; line-height: 1.8; word-break: break-word; text-align: justify; mso-line-height-alt: 25px; margin-top: 0; margin-bottom: 0;">Thank you. </p><p style="margin: 0; font-size: 14px; line-height: 1.8; word-break: break-word; text-align: justify; mso-line-height-alt: 25px; margin-top: 0; margin-bottom: 0;">MSVProperties Representative</p>',emailingUsersList:{default1:"Refer to Broker & Buyer Agents",default2:"MSV Group",admin:"MSVProperties Admin",carlota:"Carlota Panao",sara:"Sara Assaf",tamara:"Tamara Karic"},fetchRemoteAgentsAPIEndpoint:"/api/v1/geolocation?latitude={latitude}&longitude={longitude}&distance={distance}&leadid={leadid}",fetchRemoteAgentsCollectionsCachedAPIEndpoint:"/api/v1/agents?id={leadid}",fetchSingleAgentDataAPIEndpoint:"/api/v1/agent?id={id}",fetchForwardGeocodedValuesEndpoint:"https://api.positionstack.com/v1/forward?callback=callback&access_key={access_key}&query={query}&limit=1",mapPinTableContentForAgents:'<tr><th scope="row">{subject}</th><td>{new_fullname}</td><td>{new_latitude}</td><td>{new_longitude}</td></tr>',initDOM:function(){a.hideLoadingScreenComponent(),e("input").on("input change keyup",function(e){a.validateInputBoxValue(this)}),e("input").on("blur",function(e){a.sanitizeInputBoxValue(this)}),e("#btnSubmit").on("click",function(e){a.fetchLeadDatafromDynamics()}),a.initCurrentModalsInDOM(),a.initWYSIWYGEditor(),a.fetchDynamicsLeadUUIDfromParentIFrame()},initCurrentModalsInDOM:function(){e("#triggerModalAgents").click(function(){a.arrayAgentsCachedCollectionData?e("#modalAgents").modal("show"):a.fetchCachedAgentsCollectionFromRemote()}),e("#subject").val(a.subject).change(),e("#changeEmailSubject").click(function(){e("#subject").val(a.subject).change(),e("#changeSubject").modal("show")}),e("#saveSubject").click(function(){if(e("#subject").hasClass("is-invalid")){a.renderMessageBoxSWAL("Invalid Email Subject","An email subject must be a well-formed sentence.","error")}else{if(a.subject=e("#subject").val(),!a.emailBodyContent.match(/^.+\s.+$/)){return void a.renderMessageBoxSWAL("Email Empty","The content of your email is empty. Please fill in valid email content to proceed.","error")}a.emailContentsUpsert=a.emailBodyContent,e("#changeSubject").modal("hide")}}),e(".draggable-ui").draggable({handle:".modal-content",containment:"window"}),e(".dismissModal").on("click",function(e){a.closeCurrentlyOpenedModal(this)}),Object.keys(a.emailingUsersList).forEach(function(t){var n=a.emailingUsersList[t],o=t;e("#sender").append('<option value="'+o+'">'+n+"</option>")})},initWYSIWYGEditor:function(e){const t=pell.init({element:document.getElementById("editor"),onChange:e=>{window.glMSV.emailBodyContent=e},defaultParagraphSeparator:"p",styleWithCSS:!0,actions:["bold","italic","heading1","paragraph","strikethrough","olist","ulist","link","line","underline"]});t.content.innerHTML=window.glMSV.emailBodyContent},closeCurrentlyOpenedModal(t){e(t).parents().find(".modal").modal("hide")},showLoadingScreenComponent:function(){e("#loading").removeClass("hidden")},hideLoadingScreenComponent:function(){e("#loading").addClass("hidden")},renderCurrentlySelectedAgentAsModal:function(t){var n=e(this),o=n.parents().closest("tr").data("id");a.showLoadingScreenComponent(),e.ajax({type:"POST",contentType:"application/json; charset=utf-8",datatype:"json",url:a.fetchSingleAgentDataAPIEndpoint.replace("{id}",o),success:function(e){a.renderPopOverSWALHTML(e.title,e.data,null,null,"70%"),a.hideLoadingScreenComponent()},error:function(e){a.hideLoadingScreenComponent(),a.renderPopOverSWALHTML(e.title||"Error",e.message||"The agent record couldn't be found in your Dynamics 365 Database.",e.icon||"error")}})},renderTableforMapPinContent:function(){var t=a.arrayLeadDataStored,n=e("#tableContent"),o=a.mapPinTableContentForAgents;o=o.replace("{subject}",'<a target="_blank" href="'+t.hotLink+'">'+t.subject+"</a>"),o=o.replace("{new_latitude}",t.new_latitude),o=o.replace("{new_longitude}",t.new_longitude),o=o.replace("{new_fullname}",t.new_fullname),n.empty().append(o),a.hideLoadingScreenComponent()},renderMessageBoxSWAL:function(e,t,a="success",n=null){try{Swal.fire({title:e,icon:a,html:t}).then(n)}catch(e){}},renderPopOverSWALHTML:function(e,t,a=null,n=null,o=null){try{Swal.fire({title:e,html:t,icon:a,width:o,showCloseButton:!0,showConfirmButton:!1}).then(n)}catch(e){}},renderMapToDOM:function(){var n=document.getElementById("map");n.style="height:600px;",a.globalMapSelectorElement=t.map(n),a.globalMapSelectorElement.attributionControl.setPrefix('&copy; 2021 <a href="https://nobeldahal.com.np" target="_blank">Nobel Dahal</a>'),t.tileLayer("https://{s}.tile.osm.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://osm.org/copyright">OpenStreetMap</a> contributors'}).addTo(a.globalMapSelectorElement);var o=t.latLng(a.arrayLeadDataStored.new_latitude,a.arrayLeadDataStored.new_longitude),r=t.latLng(a.arrayLeadDataStored.new_latitude,a.arrayLeadDataStored.new_longitude);a.globalMapSelectorElement.setView(o,14);var i='<a target="_blank" href="'+a.arrayLeadDataStored.hotLink+'">'+a.arrayLeadDataStored.subject+"</a>";t.marker(r,{icon:a.renderCustomMapPinsGenerator()}).addTo(a.globalMapSelectorElement).bindPopup(i,{closeOnClick:!1,autoClose:!1}),e("#btnSubmit").remove(),e(".post-flight").removeClass("hidden"),e("#location").attr("disabled","disabled").addClass("disabled")},renderCustomMapPinsGenerator:function(e="/stylesheets/images/home.png",a=[25,25]){var n=t.Icon.extend({options:{iconSize:a}});return new n({iconUrl:e})},renderMapPinsforAgentsFromRemoteResult:function(){var e=a.agentarrayAgentsDataStored;Object.keys(e.data).forEach(function(n){var o=e.data[n],r=n.split(","),i=t.latLng(r[0],r[1]);t.marker(i,{icon:a.renderCustomMapPinsGenerator("/stylesheets/images/user.png",[18,25])}).addTo(a.globalMapSelectorElement).bindPopup(e.template.replace("{0}",o),{closeOnClick:!1,autoClose:!1})})},renderMapBeforeFetchingForwardGeocodedCoordinates:function(){var e=a.arrayForwardGeocodedDataStored.data.pop();a.arrayLeadDataStored.new_latitude=e.latitude,a.arrayLeadDataStored.new_longitude=e.longitude,a.renderTableforMapPinContent(),a.renderMapToDOM(),a.fetchNearbyAgentsDatafromBackend()},fetchCachedAgentsCollectionFromRemote:function(){a.showLoadingScreenComponent(),e.ajax({type:"POST",contentType:"application/json; charset=utf-8",datatype:"json",url:a.fetchRemoteAgentsCollectionsCachedAPIEndpoint.replace("{leadid}",a.arrayLeadDataStored.leadid),success:function(t){a.arrayAgentsCachedCollectionData=t,a.manageAllCachedAgentsEvents(),e("#modalAgents").modal("show"),a.hideLoadingScreenComponent()},error:function(e){a.hideLoadingScreenComponent(),a.renderMessageBoxSWAL(e.title||"Session has expired",e.message||"Computed data no longer available, please refresh the window and try again.",e.icon||"error")}})},fetchDynamicsLeadUUIDfromParentIFrame:function(){var t=!0;try{var a=window.location.search.replace("?id=","").split("&")[0];e("#location").val(a).change()}catch(e){t=!0}t||(e("nav").hide(),e("footer").hide())},fetchNearbyAgentsDatafromBackend:function(){var t=a.fetchRemoteAgentsAPIEndpoint;null===a.arrayLeadDataStored.new_longitude||null===a.arrayLeadDataStored.new_latitude||isNaN(a.arrayLeadDataStored.new_latitude)||isNaN(a.arrayLeadDataStored.new_longitude)||!isFinite(a.arrayLeadDataStored.new_latitude)||Math.abs(a.arrayLeadDataStored.new_latitude)>90||!isFinite(a.arrayLeadDataStored.new_longitude)||Math.abs(a.arrayLeadDataStored.new_longitude)>180?a.renderMessageBoxSWAL("Agents Found","Exception occured during validation: Issue with no valid latitude and longitude coordinates.","error"):(t=t.replace("{latitude}",a.arrayLeadDataStored.new_latitude).replace("{longitude}",a.arrayLeadDataStored.new_longitude).replace("{distance}",a.defaultDistanceToRenderNearbyAgents||5).replace("{leadid}",a.arrayLeadDataStored.leadid),a.showLoadingScreenComponent(),e.ajax({type:"POST",contentType:"application/json; charset=utf-8",datatype:"json",url:t,success:function(e){a.agentarrayAgentsDataStored=e,a.hideLoadingScreenComponent();var t=Object.keys(a.agentarrayAgentsDataStored.data).length;t?(a.renderMessageBoxSWAL("Agents Found","Was able to compute "+t+" nearby points. Map will be updated shortly.","success"),a.renderMapPinsforAgentsFromRemoteResult()):a.renderMessageBoxSWAL("No nearby Agents found","The system was unable to find any nearby agents in the vicinity(5 KM) of the lead. Please broaden your choice and try again.","error")},error:function(){a.hideLoadingScreenComponent(),a.renderMessageBoxSWAL("Failed Computing Agents","A network issue prevented from computing Agents locations around the lead. Please try again later.","error")}}))},fetchForwardGeocodedCoordinatesFromStreetAddress:function(){var t=e("main").data("key");null!==a.arrayLeadDataStored.new_street&&a.arrayLeadDataStored.new_street?e.getJSON(a.fetchForwardGeocodedValuesEndpoint.replace("{access_key}",t).replace("{query}",a.arrayLeadDataStored.new_street),{}).done(function(e){a.arrayForwardGeocodedDataStored=e,a.renderMapBeforeFetchingForwardGeocodedCoordinates()}).fail(function(){a.renderMessageBoxSWAL("Service Down","The geolocation service is currently down, please try again later.","error"),a.hideLoadingScreenComponent()}):(a.renderMessageBoxSWAL("Error","Geolocation services can not be accessed, the lead doesn't have a valid street address.","error"),a.hideLoadingScreenComponent())},fetchLeadDatafromDynamics:function(){if(a.showLoadingScreenComponent(),e("#tableau").fadeOut("slow"),e("input").change(),e(".is-invalid").length){return a.renderMessageBoxSWAL("Error","Invalid Lead UUID detected, computation can not occur without valid Lead UUID.","error"),void a.hideLoadingScreenComponent()}e.ajax({type:"POST",contentType:"application/json; charset=utf-8",datatype:"json",data:JSON.stringify({location:e("#location").val()}),url:a.currentPageRouteEndpoint,success:function(e){a.arrayLeadDataStored=e,null===e.new_longitude||null===e.latitude||!1===e.new_longitude||!1===e.new_latitude||isNaN(e.new_latitude)||isNaN(e.new_longitude)||!isFinite(e.new_latitude)||Math.abs(e.new_latitude)>90||!isFinite(e.new_longitude)||Math.abs(e.new_longitude)>180?(a.renderMessageBoxSWAL("Invalid coordinates detected","The script detected invalid coordinates, will now attempt to geocode the data. ","warning"),a.fetchForwardGeocodedCoordinatesFromStreetAddress()):(a.renderTableforMapPinContent(),a.renderMapToDOM(),a.fetchNearbyAgentsDatafromBackend())},error:function(e){a.hideLoadingScreenComponent(),a.renderMessageBoxSWAL("Failed Retrieving Leads","Server was unable to fulfill your request.","error")}})},fetchCheckedBoxesForEmailingAgents:function(){var t=[],n=[];e(".agent-selector").each(function(a,o){e(o).is(":checked")&&(t.push(e(o).data("check")),n.push(e(o).closest("tr").children().find(".agentSingle").data("value")))}),t.length?a.pushAgentsIDToServerForEmailing(t,n):a.renderMessageBoxSWAL("Invalid Selection","No Agents selected. Please select agents via the checkbox button.","error")},pushAgentsIDToServerForEmailing:function(e,t){a.sendEmail(e,t)},pushSingleAgentIDToServerForEmailing:function(t){var n=[e(this).closest("tr").children().find(".agent-selector").data("check")],o=[e(this).closest("tr").children().find(".agentSingle").data("value")];a.sendEmail([n],[o])},validateInputBoxValue:function(t){var n=e(t);n.removeClass("is-invalid");var o=n.attr("validation");switch(o){case"location":case"subject":n.val().match(/(^\s+$|^$)|((@|\||\*|\^|\_|%|!|~|\+)+)/i)&&n.addClass("is-invalid");break;case"search":n.val().match(/(^\s+$|^$)/i)?e(".filtered").removeClass("filtered"):a.filterOutput(n.val())}},sendEmail:(t,n=[])=>{var o=e("#sender").val()||"default";a.showLoadingScreenComponent(),e.ajax({type:"POST",contentType:"application/json",url:a.emailAgentsAPIEndpoint,data:JSON.stringify({to:t,content:a.emailContentsUpsert,names:n,sender:o,subject:a.subject}),success:function(e){a.renderMessageBoxSWAL(e.title||"Successfully Dispatched",e.message||"An autogenerated email for the selected agent/s have been dispatched.",e.icon||"success"),a.hideLoadingScreenComponent()},error:function(e){a.hideLoadingScreenComponent(),a.renderMessageBoxSWAL(e.title||"Email couldn't be sent.",e.message||"Dispatching of email failed due to mail server issues. Please try again later.",e.icon||"error")}})},sanitizeInputBoxValue:function(t){var n=e(t),o=n.val();o=o.replace(/(^\s+$|^$)|((@|\||\*|\^|\_|%|!|~|\+)+)/i,""),o=o.replace(/\s{2,}/g," "),o=o.trim(),a.matchRegexUUID(o)?(o=a.matchRegexUUID(o)[0].slice(4),n.val(o).change()):n.val(o).change()},filterOutput:function(t){var n=e(".agentSingle").map(function(){return e(this).data("value")}).get(),o=n.filter(function(e){return e.includes(t)});a.showOnlyViableAgentRows(o)},showOnlyViableAgentRows:function(t){e("div#tableAgentsListView>table>tbody>tr").addClass("filtered"),t.forEach(function(t){e(`.agentSingle[data-value="${t}"]:hidden`).closest("tr").removeClass("filtered")})},matchRegexUUID:function(e){return e.match(/&id=\b[0-9a-f]{8}\b-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-\b[0-9a-f]{12}\b/)},manageAllCachedAgentsEvents:function(){e("#tableAgentsListView").empty().append(a.arrayAgentsCachedCollectionData.data),e(".view-single").off().on("click",a.renderCurrentlySelectedAgentAsModal),e("#sendEmailAgents").off().on("click",a.fetchCheckedBoxesForEmailingAgents),e(".email-single").off().on("click",a.pushSingleAgentIDToServerForEmailing)}};window.glMSV=a,e(document).ready(function(){switch(document.location.pathname){case"/geolocation":window.glMSV.emailContentsUpsert=a.emailBodyContent,setTimeout(window.glMSV.initDOM,500);break;default:setTimeout(window.glMSV.hideLoadingScreenComponent,500),console.log("[Load finished] No scripts loaded")}})})(jQuery.noConflict(),L);