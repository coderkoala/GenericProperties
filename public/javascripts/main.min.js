(function(e,a){"use strict";var t={currentPageRouteEndpoint:"/geolocation",defaultDistanceToRenderNearbyAgents:5,fetchRemoteAgentsAPIEndpoint:"/api/v1/geolocation?latitude={latitude}&longitude={longitude}&distance={distance}&leadid={leadid}",fetchRemoteAgentsCollectionsCachedAPIEndpoint:"/api/v1/agents?id={leadid}",fetchSingleAgentDataAPIEndpoint:"/api/v1/agent?dynamics_id={id}",fetchForwardGeocodedValuesEndpoint:"https://api.positionstack.com/v1/forward?callback=callback&access_key={access_key}&query={query}&limit=1",mapPinTableContentForAgents:'<tr><th scope="row">{subject}</th><td>{new_fullname}</td><td>{new_latitude}</td><td>{new_longitude}</td></tr>',initDOM:function(){t.hideLoadingScreenComponent(),e("input").on("input change keyup",function(e){t.validateInputBoxValue(this)}),e("input").on("blur",function(e){t.sanitizeInputBoxValue(this)}),e("#btnSubmit").on("click",function(e){t.fetchLeadDatafromDynamics()}),t.initCurrentModalsInDOM(),t.fetchDynamicsLeadUUIDfromParentIFrame()},initCurrentModalsInDOM:function(){e("#triggerModalAgents").click(function(){t.arrayAgentsCachedCollectionData?e("#modalAgents").modal("show"):t.fetchCachedAgentsCollectionFromRemote()}),e(".modal-dialog").draggable({handle:".modal-content",containment:"window"}),e(".dismissModal").on("click",function(e){t.closeCurrentlyOpenedModal(this)})},closeCurrentlyOpenedModal(a){e(a).parents().find(".modal").modal("hide")},showLoadingScreenComponent:function(){e("#loading").removeClass("hidden")},hideLoadingScreenComponent:function(){e("#loading").addClass("hidden")},renderTableforMapPinContent:function(){var a=t.arrayLeadDataStored,n=e("#tableContent"),o=t.mapPinTableContentForAgents;o=o.replace("{subject}",'<a target="_blank" href="'+a.hotLink+'">'+a.subject+"</a>"),o=o.replace("{new_latitude}",a.new_latitude),o=o.replace("{new_longitude}",a.new_longitude),o=o.replace("{new_fullname}",a.new_fullname),n.empty().append(o),t.hideLoadingScreenComponent()},renderMessageBoxSWAL:function(e,a,t="success",n=null){try{Swal.fire({title:e,icon:t,html:a}).then(n)}catch(e){}},renderMapToDOM:function(){var n=document.getElementById("map");n.style="height:600px;",t.globalMapSelectorElement=a.map(n),t.globalMapSelectorElement.attributionControl.setPrefix('&copy; 2021 <a href="http://nobeldahal.com.np" target="_blank">Nobel Dahal</a>'),a.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'}).addTo(t.globalMapSelectorElement);var o=a.latLng(t.arrayLeadDataStored.new_latitude,t.arrayLeadDataStored.new_longitude),r=a.latLng(t.arrayLeadDataStored.new_latitude,t.arrayLeadDataStored.new_longitude);t.globalMapSelectorElement.setView(o,14);var d='<a target="_blank" href="'+t.arrayLeadDataStored.hotLink+'">'+t.arrayLeadDataStored.subject+"</a>";a.marker(r,{icon:t.renderCustomMapPinsGenerator()}).addTo(t.globalMapSelectorElement).bindPopup(d,{closeOnClick:!1,autoClose:!1}),e("#btnSubmit").remove(),e("#triggerModalAgents").removeClass("hidden"),e("#location").attr("disabled","disabled").addClass("disabled")},renderCustomMapPinsGenerator:function(e="/stylesheets/images/home.png",t=[25,25]){var n=a.Icon.extend({options:{iconSize:t}});return new n({iconUrl:e})},renderMapPinsforAgentsFromRemoteResult:function(){var e=t.agentarrayAgentsDataStored;Object.keys(e.data).forEach(function(n){var o=e.data[n],r=n.split(","),d=a.latLng(r[0],r[1]);a.marker(d,{icon:t.renderCustomMapPinsGenerator("/stylesheets/images/user.png",[18,25])}).addTo(t.globalMapSelectorElement).bindPopup(e.template.replace("{0}",o),{closeOnClick:!1,autoClose:!1})})},renderMapBeforeFetchingForwardGeocodedCoordinates:function(){var e=t.arrayForwardGeocodedDataStored.data.pop();t.arrayLeadDataStored.new_latitude=e.latitude,t.arrayLeadDataStored.new_longitude=e.longitude,t.renderTableforMapPinContent(),t.renderMapToDOM(),t.fetchNearbyAgentsDatafromBackend()},fetchCachedAgentsCollectionFromRemote:function(){t.showLoadingScreenComponent(),e.ajax({type:"POST",contentType:"application/json; charset=utf-8",datatype:"json",url:t.fetchRemoteAgentsCollectionsCachedAPIEndpoint.replace("{leadid}",t.arrayLeadDataStored.leadid),success:function(a){t.arrayAgentsCachedCollectionData=a,t.renderMessageBoxSWAL(a.title,a.message,a.icon,function(){e("#tableAgentsListView").empty().append(t.arrayAgentsCachedCollectionData.data),e("#modalAgents").modal("show")}),t.hideLoadingScreenComponent()},error:function(e){t.hideLoadingScreenComponent(),t.renderMessageBoxSWAL(e.title||"Error",e.message||"Network Error occured. Please try again later.",e.icon||"error")}})},fetchDynamicsLeadUUIDfromParentIFrame:function(){var a=!0;try{var t=window.location.search.replace("?id=","").split("&")[0];e("#location").val(t).change()}catch(e){a=!0}a||(e("nav").hide(),e("footer").hide())},fetchNearbyAgentsDatafromBackend:function(){var a=t.fetchRemoteAgentsAPIEndpoint;null===t.arrayLeadDataStored.new_longitude||null===t.arrayLeadDataStored.new_latitude||isNaN(t.arrayLeadDataStored.new_latitude)||isNaN(t.arrayLeadDataStored.new_longitude)||!isFinite(t.arrayLeadDataStored.new_latitude)||Math.abs(t.arrayLeadDataStored.new_latitude)>90||!isFinite(t.arrayLeadDataStored.new_longitude)||Math.abs(t.arrayLeadDataStored.new_longitude)>180?t.renderMessageBoxSWAL("Agents Found","Exception occured during validation: Issue with no valid latitude and longitude coordinates.","error"):(a=a.replace("{latitude}",t.arrayLeadDataStored.new_latitude).replace("{longitude}",t.arrayLeadDataStored.new_longitude).replace("{distance}",t.defaultDistanceToRenderNearbyAgents||5).replace("{leadid}",t.arrayLeadDataStored.leadid),t.showLoadingScreenComponent(),e.ajax({type:"POST",contentType:"application/json; charset=utf-8",datatype:"json",url:a,success:function(e){t.agentarrayAgentsDataStored=e,t.hideLoadingScreenComponent();var a=Object.keys(t.agentarrayAgentsDataStored.data).length;a?(t.renderMessageBoxSWAL("Agents Found","Was able to compute "+a+" nearby points. Map will be updated shortly.","success"),t.renderMapPinsforAgentsFromRemoteResult()):t.renderMessageBoxSWAL("No nearby Agents found","The system was unable to find any nearby agents in the vicinity(5 KM) of the lead. Please broaden your choice and try again.","error")},error:function(){t.hideLoadingScreenComponent(),t.renderMessageBoxSWAL("Failed Computing Agents","A network issue prevented from computing Agents locations around the lead. Please try again later.","error")}}))},fetchForwardGeocodedCoordinatesFromStreetAddress:function(){var a=e("main").data("key");null!==t.arrayLeadDataStored.new_street&&t.arrayLeadDataStored.new_street?e.getJSON(t.fetchForwardGeocodedValuesEndpoint.replace("{access_key}",a).replace("{query}",t.arrayLeadDataStored.new_street),{}).done(function(e){t.arrayForwardGeocodedDataStored=e,t.renderMapBeforeFetchingForwardGeocodedCoordinates()}).fail(function(){t.renderMessageBoxSWAL("Service Down","The geolocation service is currently down, please try again later.","error"),t.hideLoadingScreenComponent()}):(t.renderMessageBoxSWAL("Error","Geolocation services can not be accessed, the lead doesn't have a valid street address.","error"),t.hideLoadingScreenComponent())},fetchLeadDatafromDynamics:function(){if(t.showLoadingScreenComponent(),e("#tableau").fadeOut("slow"),e("input").change(),e(".is-invalid").length){return t.renderMessageBoxSWAL("Error","Invalid Lead UUID detected, computation can not occur without valid Lead UUID.","error"),void t.hideLoadingScreenComponent()}e.ajax({type:"POST",contentType:"application/json; charset=utf-8",datatype:"json",data:JSON.stringify({location:e("#location").val()}),url:t.currentPageRouteEndpoint,success:function(e){t.arrayLeadDataStored=e,null===e.new_longitude||null===e.latitude||!1===e.new_longitude||!1===e.new_latitude||isNaN(e.new_latitude)||isNaN(e.new_longitude)||!isFinite(e.new_latitude)||Math.abs(e.new_latitude)>90||!isFinite(e.new_longitude)||Math.abs(e.new_longitude)>180?(t.renderMessageBoxSWAL("Invalid coordinates detected","The script detected invalid coordinates, will now attempt to geocode the data. ","warning"),t.fetchForwardGeocodedCoordinatesFromStreetAddress()):(t.renderTableforMapPinContent(),t.renderMapToDOM(),t.fetchNearbyAgentsDatafromBackend())},error:function(e){t.hideLoadingScreenComponent(),t.renderMessageBoxSWAL("Failed Retrieving Leads",e.responseJSON.error,"error")}})},validateInputBoxValue:function(a){var t=e(a);t.removeClass("is-invalid");var n=t.attr("validation");switch(n){case"location":t.val().match(/(^\s+$|^$)|((@|\||\*|\^|\_|%|!|~|\+)+)/i)&&t.addClass("is-invalid")}},sanitizeInputBoxValue:function(a){var n=e(a),o=n.val();o=o.replace(/(^\s+$|^$)|((@|\||\*|\^|\_|%|!|~|\+)+)/i,""),o=o.replace(/\s{2,}/g," "),o=o.trim(),t.matchRegexUUID(o)?(o=t.matchRegexUUID(o)[0].slice(4),n.val(o).change()):n.val(o).change()},matchRegexUUID:function(e){return e.match(/&id=\b[0-9a-f]{8}\b-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-\b[0-9a-f]{12}\b/)}};window.glMSV=t,e(document).ready(function(){switch(document.location.pathname){case"/geolocation":setTimeout(window.glMSV.initDOM,500);break;default:setTimeout(window.glMSV.hideLoadingScreenComponent,500),console.log("[Load finished] No scripts loaded")}})})(jQuery.noConflict(),L);