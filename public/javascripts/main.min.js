(function(e,t){"use strict";var a={currentPageRouteEndpoint:"/geolocation",defaultDistanceToRenderNearbyAgents:5,fetchRemoteAgentsAPIEndpoint:"/api/v1/geolocation?latitude={latitude}&longitude={longitude}&distance={distance}&leadid={leadid}",fetchSingleAgentDataAPIEndpoint:"/api/v1/agent?dynamics_id={id}",fetchForwardGeocodedValuesEndpoint:"https://api.positionstack.com/v1/forward?callback=callback&access_key={access_key}&query={query}&limit=1",mapPinTableContentForAgents:'<tr><th scope="row">{subject}</th><td>{new_fullname}</td><td>{new_latitude}</td><td>{new_longitude}</td></tr>',initDOM:function(){a.hideLoadingScreenComponent(),e("input").on("input change keyup",function(e){a.validateInputBoxValue(this)}),e("input").on("blur",function(e){a.sanitizeInputBoxValue(this)}),e("#btnSubmit").on("click",function(e){a.fetchLeadDatafromDynamics()}),a.initCurrentModalsInDOM(),a.fetchDynamicsLeadUUIDfromParentIFrame()},initCurrentModalsInDOM:function(){e("#triggerModalAgents").click(function(){e("#modalAgents").modal("show"),e(".modal-dialog").draggable({handle:".modal-content",containment:"window"})}),e(".dismissModal").on("click",function(e){a.closeCurrentlyOpenedModal(this)})},closeCurrentlyOpenedModal(t){e(t).parents().find(".modal").modal("hide")},showLoadingScreenComponent:function(){e("#loading").removeClass("hidden")},hideLoadingScreenComponent:function(){e("#loading").addClass("hidden")},renderTableforMapPinContent:function(){var t=a.arrayAgentsDataStored,n=e("#tableContent"),o=a.mapPinTableContentForAgents;o=o.replace("{subject}",'<a target="_blank" href="'+t.hotLink+'">'+t.subject+"</a>"),o=o.replace("{new_latitude}",t.new_latitude),o=o.replace("{new_longitude}",t.new_longitude),o=o.replace("{new_fullname}",t.new_fullname),n.empty().append(o),a.hideLoadingScreenComponent()},renderMessageBoxSWAL:function(e,t,a="success"){Swal.fire({title:e,icon:a,html:t})},renderMapToDOM:function(){var n=document.getElementById("map");n.style="height:600px;",a.globalMapSelectorElement=t.map(n),a.globalMapSelectorElement.attributionControl.setPrefix('&copy; 2021 <a href="http://nobeldahal.com.np" target="_blank">Nobel Dahal</a>'),t.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'}).addTo(a.globalMapSelectorElement);var o=t.latLng(a.arrayAgentsDataStored.new_latitude,a.arrayAgentsDataStored.new_longitude),r=t.latLng(a.arrayAgentsDataStored.new_latitude,a.arrayAgentsDataStored.new_longitude);a.globalMapSelectorElement.setView(o,14);var i='<a target="_blank" href="'+a.arrayAgentsDataStored.hotLink+'">'+a.arrayAgentsDataStored.subject+"</a>";t.marker(r,{icon:a.renderCustomMapPinsGenerator()}).addTo(a.globalMapSelectorElement).bindPopup(i,{closeOnClick:!1,autoClose:!1}),e("#btnSubmit").remove(),e("#triggerModalAgents").removeClass("hidden"),e("#location").attr("disabled","disabled").addClass("disabled")},renderCustomMapPinsGenerator:function(e="/stylesheets/images/home.png",a=[25,25]){var n=t.Icon.extend({options:{iconSize:a}});return new n({iconUrl:e})},renderMapPinsforAgentsFromRemoteResult:function(){var e=a.agentarrayAgentsDataStored;Object.keys(e.data).forEach(function(n){var o=e.data[n],r=n.split(","),i=t.latLng(r[0],r[1]);t.marker(i,{icon:a.renderCustomMapPinsGenerator("/stylesheets/images/user.png",[18,25])}).addTo(a.globalMapSelectorElement).bindPopup(e.template.replace("{0}",o),{closeOnClick:!1,autoClose:!1})})},renderMapBeforeFetchingForwardGeocodedCoordinates:function(){var e=a.arrayForwardGeocodedDataStored.data.pop();a.arrayAgentsDataStored.new_latitude=e.latitude,a.arrayAgentsDataStored.new_longitude=e.longitude,a.renderTableforMapPinContent(),a.renderMapToDOM(),a.fetchNearbyAgentsDatafromBackend()},fetchDynamicsLeadUUIDfromParentIFrame:function(){var t=!0;try{var a=window.location.search.replace("?id=","").split("&")[0];e("#location").val(a).change()}catch(e){t=!0}t||(e("nav").hide(),e("footer").hide())},fetchNearbyAgentsDatafromBackend:function(){var t=a.fetchRemoteAgentsAPIEndpoint;null===a.arrayAgentsDataStored.new_longitude||null===a.arrayAgentsDataStored.new_latitude||isNaN(a.arrayAgentsDataStored.new_latitude)||isNaN(a.arrayAgentsDataStored.new_longitude)||!isFinite(a.arrayAgentsDataStored.new_latitude)||Math.abs(a.arrayAgentsDataStored.new_latitude)>90||!isFinite(a.arrayAgentsDataStored.new_longitude)||Math.abs(a.arrayAgentsDataStored.new_longitude)>180?a.renderMessageBoxSWAL("Agents Found","Exception occured during validation: Issue with no valid latitude and longitude coordinates.","error"):(t=t.replace("{latitude}",a.arrayAgentsDataStored.new_latitude).replace("{longitude}",a.arrayAgentsDataStored.new_longitude).replace("{distance}",a.defaultDistanceToRenderNearbyAgents||5).replace("{leadid}",a.arrayAgentsDataStored.leadid),a.showLoadingScreenComponent(),e.ajax({type:"POST",contentType:"application/json; charset=utf-8",datatype:"json",url:t,success:function(e){a.agentarrayAgentsDataStored=e,a.hideLoadingScreenComponent();var t=Object.keys(a.agentarrayAgentsDataStored.data).length;t?(a.renderMessageBoxSWAL("Agents Found","Was able to compute "+t+" nearby points. Map will be updated shortly.","success"),a.renderMapPinsforAgentsFromRemoteResult()):a.renderMessageBoxSWAL("No nearby Agents found","The system was unable to find any nearby agents in the vicinity(5 KM) of the lead. Please broaden your choice and try again.","error")},error:function(){a.hideLoadingScreenComponent(),a.renderMessageBoxSWAL("Failed Computing Agents","A network issue prevented from computing Agents locations around the lead. Please try again later.","error")}}))},fetchForwardGeocodedCoordinatesFromStreetAddress:function(){var t=e("main").data("key");null!==a.arrayAgentsDataStored.new_street&&a.arrayAgentsDataStored.new_street?e.getJSON(a.fetchForwardGeocodedValuesEndpoint.replace("{access_key}",t).replace("{query}",a.arrayAgentsDataStored.new_street),{}).done(function(e){a.arrayForwardGeocodedDataStored=e,a.renderMapBeforeFetchingForwardGeocodedCoordinates()}).fail(function(){a.renderMessageBoxSWAL("Service Down","The geolocation service is currently down, please try again later.","error"),a.hideLoadingScreenComponent()}):(a.renderMessageBoxSWAL("Error","Geolocation services can not be accessed, the lead doesn't have a valid street address.","error"),a.hideLoadingScreenComponent())},fetchLeadDatafromDynamics:function(){if(a.showLoadingScreenComponent(),e("#tableau").fadeOut("slow"),e("input").change(),e(".is-invalid").length){return a.renderMessageBoxSWAL("Error","Invalid Lead UUID detected, computation can not occur without valid Lead UUID.","error"),void a.hideLoadingScreenComponent()}e.ajax({type:"POST",contentType:"application/json; charset=utf-8",datatype:"json",data:JSON.stringify({location:e("#location").val()}),url:a.currentPageRouteEndpoint,success:function(e){a.arrayAgentsDataStored=e,null===e.new_longitude||null===e.latitude||!1===e.new_longitude||!1===e.new_latitude||isNaN(e.new_latitude)||isNaN(e.new_longitude)||!isFinite(e.new_latitude)||Math.abs(e.new_latitude)>90||!isFinite(e.new_longitude)||Math.abs(e.new_longitude)>180?(a.renderMessageBoxSWAL("Invalid coordinates detected","The script detected invalid coordinates, will now attempt to geocode the data. ","warning"),a.fetchForwardGeocodedCoordinatesFromStreetAddress()):(a.renderTableforMapPinContent(),a.renderMapToDOM(),a.fetchNearbyAgentsDatafromBackend())},error:function(e){a.hideLoadingScreenComponent(),a.renderMessageBoxSWAL("Failed Retrieving Leads",e.responseJSON.error,"error")}})},validateInputBoxValue:function(t){var a=e(t);a.removeClass("is-invalid");var n=a.attr("validation");switch(n){case"location":a.val().match(/(^\s+$|^$)|((@|\||\*|\^|\_|%|!|~|\+)+)/i)&&a.addClass("is-invalid")}},sanitizeInputBoxValue:function(t){var n=e(t),o=n.val();o=o.replace(/(^\s+$|^$)|((@|\||\*|\^|\_|%|!|~|\+)+)/i,""),o=o.replace(/\s{2,}/g," "),o=o.trim(),a.matchRegexUUID(o)?(o=a.matchRegexUUID(o)[0].slice(4),n.val(o).change()):n.val(o).change()},matchRegexUUID:function(e){return e.match(/&id=\b[0-9a-f]{8}\b-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-\b[0-9a-f]{12}\b/)}};window.this_=a,e(document).ready(function(){switch(document.location.pathname){case"/geolocation":setTimeout(window.this_.initDOM,500);break;default:setTimeout(window.this_.hideLoadingScreenComponent,500),console.log("[Load finished] No scripts loaded")}})})(jQuery.noConflict(),L);